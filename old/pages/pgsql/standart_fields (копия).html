<!DOCTYPE html>
<html lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <title>Создание стандартный полей: ts_create, ts_modify, user_id, modify_user_id</title>
    <link href="../../src/css/fonts.css" rel="stylesheet">
    <link href="../../src/css/main.css" media="screen" rel="stylesheet">
    <link href="../../src/css/monokai-sublime.css" rel="stylesheet">
    <script src="../../src/js/jquery-3.2.1.min.js">
    </script>
    <script src="../../src/js/highlight.pack.js">
    </script>
</head>
<body>
    <header class="site-header">
        <ul class="breadcrumbs"></ul>
        <div class="inner">
            <h1 class="site-title"><a class="logo-text" href="https://avis20.github.io/doc/">avis notes</a></h1>
            <p class="site-description">Thoughts, stories and ideas.</p>
        </div><!-- .inner -->
    </header>
    <div class="site-content">
        <div class="inner">
            <main class="site-main">
                <article class="post format-standard hentry">
                    <header class="entry-header">
                        <div class="entry-header-wrap">
                            <h2 class="entry-title">Создание стандартный полей: ts_create, ts_modify, user_id, modify_user_id</h2>
                        </div><!-- .entry-header-wrap -->
                        <div class="entry-meta">
                            by <span class="post-author author vcard"><span class="fn">Orlov Yaroslav</span></span> on <time class="published" datetime="27-01-2018">29-01-2018</time>
                        </div><!-- .entry-meta -->
                    </header><!-- .entry-header -->
                    <div class="entry-content">

                        <h3 id="Поля">Поля</h3>

<!-- ------------------------------------------------------------- -->

<pre><code class="sql">ALTER TABLE schema.table
  ADD COLUMN ts_create TIMESTAMP(0) WITHOUT TIME ZONE DEFAULT now() NOT NULL;

ALTER TABLE schema.table
  ADD COLUMN ts_modify TIMESTAMP(0) WITHOUT TIME ZONE;

ALTER TABLE schema.table
  ADD COLUMN user_id INTEGER NOT NULL;

ALTER TABLE schema.table
  ADD COLUMN modify_user_id INTEGER;

ALTER TABLE schema.table
  ADD COLUMN _trigger_off BOOLEAN;

COMMENT ON COLUMN schema.table.ts_create
IS 'Дата создания записи';

COMMENT ON COLUMN schema.table.ts_modify
IS 'Дата последнего обновления';

COMMENT ON COLUMN schema.table.user_id
IS 'Пользователь создавший запись';

COMMENT ON COLUMN schema.table.modify_user_id
IS 'Пользователь изменивший запись';
</code></pre>

<!-- ------------------------------------------------------------- -->

                        <h3 id="DBIx">DBIx</h3>

<pre><code class="perl">
    'ts_create',
        {
            data_type           => 'datetime',
            timezone            => 'local',
            is_nullable         => 0,
            default_value       => \'now()',
            retrieve_on_insert  => 1
        },
    'ts_modify',
        {
            data_type           => 'datetime',
            timezone            => 'local',
            is_nullable         => 1,
        },
    'user_id',
        {
            data_type           => 'integer',
            is_nullable         => 0
        },
    'modify_user_id',
        {
            data_type           => 'integer',
            is_nullable         => 1
        },
</code></pre>

<!-- ------------------------------------------------------------- -->

                        <h3 id="Функции">Функции</h3>

<pre><code class="sql">CREATE OR REPLACE FUNCTION offer.check_item (
  offer_id integer,
  params json = '{}'::json
)
RETURNS offer.items AS
$body$
DECLARE
    r_offer       "offer"."items";
BEGIN
    IF offer_id IS NULL THEN
        RAISE WARNING '{"success":0,"error":428,"error_field":"offer_id","params":%}', params;
        RETURN NULL;
    END IF;

    SELECT * INTO r_offer FROM "offer"."items" WHERE id = offer_id;

    IF r_offer.id IS NULL THEN
        RAISE WARNING '{"success":0,"error":424,"error_field":"offer_id","params":%}', params;
        RETURN NULL;
    END IF;
    
    RETURN r_offer;
END;
$body$
LANGUAGE 'plpgsql'
VOLATILE
CALLED ON NULL INPUT
SECURITY INVOKER;
</code></pre>

<!-- ------------------------------------------------------------- -->

                        <h3 id="Триггеры">Триггеры</h3>

<h4>Insert</h4>

<pre><code class="sql">CREATE OR REPLACE FUNCTION service._items_insert_before_trigger (
)
RETURNS trigger AS
$body$
DECLARE 
    r_user      "public"."users";
BEGIN
    IF NEW._trigger_off IS TRUE THEN
        RETURN NEW;
    END IF;

    NEW.ts_create       := now();
    NEW.ts_modify       := now();
    NEW.modify_user_id  := NEW.user_id;

-- check user
    SELECT * INTO r_user 
        FROM "public".check_user(NEW.user_id, row_to_json(NEW));
    IF r_user.id IS NULL THEN
        RETURN NULL;
    END IF;

    RETURN NEW;
END;
$body$
LANGUAGE 'plpgsql'
VOLATILE
CALLED ON NULL INPUT
SECURITY INVOKER;

CREATE TRIGGER items_insert_before
  BEFORE INSERT 
  ON service.items
  
FOR EACH ROW 
  EXECUTE PROCEDURE service._items_insert_before_trigger();

</code></pre>

<!-- ------------------------------------------------------------- -->

<h4>Update</h4>
<p>блокировать изменение системных полей</p>
<pre><code class="sql">CREATE FUNCTION schema._table_update_before_trigger (
)
RETURNS trigger AS
$body$
DECLARE 
    r_user             "public"."users";
BEGIN
    IF NEW._trigger_off IS TRUE THEN
        NEW._trigger_off := NULL;
        RETURN NEW;
    END IF;

-- blocked update fields
    NEW.id              := OLD.id;
    NEW.user_id         := OLD.user_id;
    NEW.ts_create       := OLD.ts_create;

-- check modify user
    SELECT * INTO r_user FROM "public".check_user(NEW.modify_user_id, row_to_json(NEW), 'modify_user_id');
    IF r_user.id IS NULL THEN
        RETURN OLD;
    END IF;

    RETURN NEW;
END
$body$
LANGUAGE 'plpgsql'
VOLATILE
CALLED ON NULL INPUT
SECURITY INVOKER;

CREATE TRIGGER table_update_before
  BEFORE UPDATE 
  ON schema.table
  
FOR EACH ROW 
  EXECUTE PROCEDURE schema._table_update_before_trigger();
</code></pre>

<h4>Delete</h4>

<!-- ------------------------------------------------------------- -->

<p>блокировать удаление если есть история</p>
<pre><code class="sql">CREATE FUNCTION schema._table_delete_before_trigger (
)
RETURNS trigger AS
$body$
DECLARE 
    r_services  "contract"."services";
BEGIN

-- check history
    SELECT * INTO r_services FROM "contract"."services" WHERE service_id = OLD.id;
    IF r_services.id IS NULL THEN
        RAISE WARNING '{"success":0,"error":1003}';
        RETURN NULL;
    END IF;

    RETURN OLD;
END;
$body$
LANGUAGE 'plpgsql'
VOLATILE
CALLED ON NULL INPUT
SECURITY INVOKER;

CREATE TRIGGER table_delete_before
  BEFORE DELETE 
  ON schema.table
  
FOR EACH ROW 
  EXECUTE PROCEDURE schema._table_delete_before_trigger();
</code></pre>

                        <table>

<!-- ------------------------------------------------------------- -->

<tr><td>
    
    <p>test</p>

</td><td>

<pre><code class="shell">
</code></pre>

</td></tr>

</table>

<!-- ------------------------------------------------------------- -->

<h3 id="reference">Reference</h3>

<ul>

    <li></li>

</ul>
</div></article></main>

<aside class="sidebar">

    <section class="widget widget-recent-posts">
        <h2 class="widget-title">Toc</h2>
        <div class="toc"></div>
        <h2 class="widget-title">Notes</h2><iframe frameborder="0" height="500px" src="../../tree.html"></iframe>
    </section><!-- .widget-recent-posts -->

</aside><script src="../../src/js/main.js"></script> 

</div></div></body></html>